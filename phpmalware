#!/bin/bash
# Name: PHPMalware
# Version: 2017-10-20
# Description: Check for malwares within PHP code based on POST requests and PHP files content.
# Developer: Robin Labadie
# Websites: haisoft.fr | lrob.fr | terageek.org

## Directories
siteslocation="/var/www/vhosts"
# Log location relative to website, so $siteslocation/log
sitelog="logs/access_log"
sitelog_ssl="logs/access_ssl_log"

# Exclude from log detection
excludelogs="303
404
503
403
index.php
admin-ajax.php
wp-cron.php
wp-login.php
wp-comment.php"

##############
### Script ###
##############

## Misc Vars
selfname="PHPMalware"
currdate="$(LC_ALL=en_GB.UTF8 date +'%d/%b/%Y')"

# Download bash API
if [ ! -f "ultimate-bash-api.sh" ]; then
	wget https://raw.githubusercontent.com/UltimateByte/ultimate-bash-api/master/ultimate-bash-api.sh
	chmod +x ultimate-bash-api.sh
fi
source ultimate-bash-api.sh

fn_detect_logs(){
	# Search through domains
	for domain in $(find "${siteslocation}" -type d -maxdepth 1 -printf '%P\n'); do
		# Search into HTTP logs for the given domain
		postdetect="$(grep "POST" "${siteslocation}/${domain}/${sitelog}" | grep "${currdate}:" | grep ".php" | grep -Fv -e "${excludelogs}" | cut -d " " -f 7 | uniq;)"
		# Search into HTTPS logs for the given domain
		postdetect_ssl="$(grep "POST" "${siteslocation}/${domain}/${sitelog_ssl}" | grep "${currdate}:" | grep ".php" | grep -Fv -e "${excludelogs}" | cut -d " " -f 7 | uniq;)"
		# Malicious Posts found in HTTP requests
		if [ -n "${postdetect}" ]; then
			echo "Detected http://${domain}: ${postdetect}"
		fi
		# Malicious Posts found in HTTPS requests
		if [ -n "${postdetect_ssl}" ]; then
			echo "Detected https://${domain}: ${postdetect_ssl}"
		fi
	done
}
fn_detect_logs
